<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Grammar - E'arab & Sarf</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .result-table thead {
            background: linear-gradient(135deg, #10B981 0%, #14B8A6 100%);
            color: white;
        }

        .result-table th {
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
        }

        .result-table td {
            padding: 14px 12px;
            text-align: center;
            border-bottom: 1px solid #e1e4e8;
            font-size: 0.93em;
        }

        .result-table tbody tr:hover {
            background: #f8f9fa;
        }

        .result-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mobile Card Style for Results */
        .mobile-cards {
            display: none;
        }

        .result-card-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f1f2;
        }

        .result-card-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .result-card-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .result-card-value {
            color: #2c3e50;
            font-size: 0.95em;
            text-align: left;
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            .result-table {
                display: none;
            }

            .mobile-cards {
                display: block;
            }
        }
    </style>
</head>

<body>
    <!-- Desktop Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-logo">
                <span>Quran Grammar</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-item">E'arab</a>
                <a href="sarf.html" class="nav-item active">Sarf</a>
                <a href="about.html" class="nav-item">About</a>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <section class="page-hero">
            <h1>Morphology Analysis <span class="arabic-term">(صرف)</span></h1>
            <p class="page-description">Analyze Arabic words to discover their root, form, and grammatical structure</p>
        </section>

        <div class="card">
            <form id="sarfForm">
                <div class="form-group">
                    <label for="wordInput">Enter Arabic Word <span class="arabic-term">(كلمة عربية)</span></label>
                    <input type="text" id="wordInput" class="arabic-text" placeholder="مثال: رددنا" required>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%">
                    Analyze
                </button>
            </form>
        </div>

        <div id="loadingSpinner" class="loading-container hidden">
            <div class="spinner"></div>
            <p class="loading-text">Analyzing word...</p>
        </div>

        <div id="result" class="result hidden fade-in">
            <!-- Results will be injected here -->
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            <span>E'arab</span>
        </a>
        <a href="sarf.html" class="bottom-nav-item active">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
            </svg>
            <span>Sarf</span>
        </a>
        <a href="about.html" class="bottom-nav-item">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>About</span>
        </a>
    </nav>

    <script src="script.js"></script>
    <script>
        // Handle form submission
        document.getElementById('sarfForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const wordInput = document.getElementById('wordInput');
            const word = wordInput.value.trim();

            if (!word) {
                alert('الرجاء إدخال كلمة عربية');
                return;
            }

            await analyzeSarf(word);
        });

        // Initialize & Restore State
        document.addEventListener('DOMContentLoaded', () => {
            const savedWord = localStorage.getItem('lastSarfWord');
            const savedAnalysis = localStorage.getItem('lastSarfAnalysis');
            const wordInput = document.getElementById('wordInput');

            if (savedWord) {
                wordInput.value = savedWord;
            }

            if (savedAnalysis && savedWord) {
                try {
                    const analysis = JSON.parse(savedAnalysis);
                    if (analysis.word === savedWord) {
                        displayResults(analysis.data);
                        document.getElementById('result').classList.remove('hidden');
                    }
                } catch (e) {
                    console.warn('Failed to restore Sarf analysis', e);
                    localStorage.removeItem('lastSarfAnalysis');
                }
            }
        });

        // Function to analyze Sarf
        async function analyzeSarf(word) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const result = document.getElementById('result');

            try {
                // Show loading
                loadingSpinner.classList.remove('hidden');
                result.classList.add('hidden');
                result.innerHTML = ''; // Clear previous results

                // Generate timestamp for cache busting
                const timestamp = new Date().getTime();

                // Build API URL
                const apiUrl = `https://aratools.com/api/v1/dictionary/lookup/ar/${encodeURIComponent(word)}?filter_diacritics=true&_=${timestamp}`;

                // Try multiple CORS proxies
                const proxies = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`,
                    apiUrl // Try direct access last
                ];

                let data = null;
                let lastError = null;

                // Try each proxy until one works
                for (const proxyUrl of proxies) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);

                        const response = await fetch(proxyUrl, {
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        // Check if response is JSON (allorigins format)
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const jsonData = await response.json();
                            if (jsonData.contents) {
                                data = JSON.parse(jsonData.contents);
                            } else {
                                data = jsonData;
                            }
                        } else {
                            const text = await response.text();
                            data = JSON.parse(text);
                        }

                        if (data && data.words) {
                            console.log('Successfully fetched from:', proxyUrl);
                            break;
                        }
                    } catch (error) {
                        lastError = error;
                        console.warn('Proxy failed:', proxyUrl, error.message);
                        continue;
                    }
                }

                if (!data || !data.words) {
                    throw lastError || new Error('Failed to fetch data');
                }

                // Save to cache
                localStorage.setItem('lastSarfWord', word);
                try {
                    const cacheData = {
                        word: word,
                        data: data.words,
                        timestamp: new Date().getTime()
                    };
                    localStorage.setItem('lastSarfAnalysis', JSON.stringify(cacheData));
                } catch (e) {
                    console.warn('Failed to save Sarf analysis to cache', e);
                }

                displayResults(data.words);
                result.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                result.innerHTML = `
                    <div class="card" style="background: #fee; border-color: #fcc;">
                        <p style="color: #c33; text-align: center;">
                            Failed to analyze word. Please try again later.
                            <br><small>${error.message}</small>
                        </p>
                    </div>
                `;
                result.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function displayResults(words) {
            const resultDiv = document.getElementById('result');

            if (words.length === 0) {
                resultDiv.innerHTML = `
                    <div class="card">
                        <p class="text-center" style="color: var(--text-muted);">No results found for this word.</p>
                    </div>
                `;
                return;
            }

            // Create Table for Desktop
            let tableHtml = `
                <div class="result-table-container">
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Form</th>
                                <th>Gloss</th>
                                <th>POS</th>
                                <th>Root</th>
                                <th>Measure</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Create Cards for Mobile
            let cardsHtml = '<div class="mobile-cards">';

            words.forEach(word => {
                const arabicWord = word.voc_form || word.form;
                const root = word.root || '-';
                const pos = word.pos_nice || word.pos_abbr || '-';
                const gloss = word.nice_gloss || word.gloss || '-';
                const measure = word.measure || '-';

                // Table Row
                tableHtml += `
                    <tr>
                        <td class="arabic-text" style="font-size: 1.2em; font-weight: bold;">${arabicWord}</td>
                        <td>${gloss}</td>
                        <td>${pos}</td>
                        <td class="arabic-text">${root}</td>
                        <td>${measure}</td>
                    </tr>
                `;

                // Mobile Card
                cardsHtml += `
                    <div class="card result-card">
                        <div class="result-card-row">
                            <span class="result-card-label">Form</span>
                            <span class="result-card-value arabic-text" style="font-size: 1.2em; font-weight: bold;">${arabicWord}</span>
                        </div>
                        <div class="result-card-row">
                            <span class="result-card-label">Gloss</span>
                            <span class="result-card-value">${gloss}</span>
                        </div>
                        <div class="result-card-row">
                            <span class="result-card-label">POS</span>
                            <span class="result-card-value">${pos}</span>
                        </div>
                        <div class="result-card-row">
                            <span class="result-card-label">Root</span>
                            <span class="result-card-value arabic-text">${root}</span>
                        </div>
                        <div class="result-card-row">
                            <span class="result-card-label">Measure</span>
                            <span class="result-card-value">${measure}</span>
                        </div>
                    </div>
                `;
            });

            tableHtml += '</tbody></table></div>';
            cardsHtml += '</div>';

            resultDiv.innerHTML = tableHtml + cardsHtml;
        }
    </script>
</body>

</html>